---
sidebar_position: 1
---

# Introduction

```ts title="Full example, using Zod for schemas and Sequelize for database interaction" showLineNumbers
// file: src/logic/server/auth.ts noEmit
export declare function getAuthTokens(headers: any): { tokens: true };
export declare function getTokenForBody(headers: any): string;

// file: src/logic/server/books.ts noEmit
import type { NextApiRequest } from 'next';
import {
  Model,
  InferAttributes,
  InferCreationAttributes,
  CreationOptional,
} from 'sequelize';

export class Book extends Model<
  InferAttributes<Book>,
  InferCreationAttributes<Book>
> {
  declare id: CreationOptional<number>;
  declare name: string;
  declare author: string;
}

export declare function getBookFromReq(req: NextApiRequest): Book;

// file: src/schemas/index.ts noEmit
import { ZodSchema } from 'zod';

export const schemaToInvariant = <T>(schema: ZodSchema<T>) =>
  function (val: any): asserts val is T {
    schema.parse(val);
  };

// file: src/schemas/books.ts noEmit
import { InferAttributes } from 'sequelize';
import z, { ZodSchema } from 'zod';
import { Book } from '../logic/server/books';

export const BookSchema = z.object({
  id: z.number(),
  name: z.string(),
  author: z.string(),
}) satisfies ZodSchema<InferAttributes<Book>>;

// file: src/logic/server/index.ts
import { createEndpointFactory } from 'next-create-endpoint-handler';
import { getAuthTokens } from './auth';

export const createEndpoint = createEndpointFactory({
  authenticate: (req) => getAuthTokens(req.headers),
});

// file: pages/api/books/index.ts
import { alwaysMatch } from 'next-create-endpoint-handler';
import { createEndpoint } from '../../../src/logic/server';
import { Book } from '../../../src/logic/server/books';
import { schemaToInvariant } from '../../../src/schemas';
import { BookSchema } from '../../../src/schemas/books';

export default createEndpoint({
  methods: (build) => ({
    // error-next-line
    get: build.method<{ books: Book[] }>({
      handler: async () => ({
        books: await Book.findAll(),
      }),
    }),
    post: build.method({
      // highlight-start
      validators: {
        body: schemaToInvariant(BookSchema.omit({ id: true })),
        response: alwaysMatch<{ id: number }>(),
      },
      // highlight-end
      handler: async (req, res, { failWithCode, succeedWithCode }) => {
        const { id } = await Book.create(req.body);
        res.setHeader('Location', `api/books/${id}`);
        return succeedWithCode(201, { id });
      },
    }),
  }),
}).handler;

// file: pages/api/books/[id].ts
import { alwaysMatch } from 'next-create-endpoint-handler';
import { createEndpoint } from '../../../src/logic/server';
import { Book, getBookFromReq } from '../../../src/logic/server/books';
import { schemaToInvariant } from '../../../src/schemas';
import { BookSchema } from '../../../src/schemas/books';

export default createEndpoint({
  methods: (build) => ({
    // highlight-next-line
    get: build.method<Book>({
      handler: async (req, res, { failWithCode }) => await getBookFromReq(req),
    }),
    patch: build.method({
      // error-start
      validators: {
        body: schemaToInvariant(BookSchema.omit({ id: true }).partial()),
        query: (query): query is { id: string } => typeof query.id == 'string',
        response: alwaysMatch<void>(),
      },
      // error-end
      handler: async (req, res, { failWithCode }) => {
        const book = await getBookFromReq(req);
        if (!book) {
          throw failWithCode(404, 'Book not found');
        }
        await book.update(req.body);
        // we don't return anything, so code is automatically 204
      },
    }),
    delete: build.method<void>({
      handler: async (req, res, { failWithCode }) => {
        const book = await getBookFromReq(req);
        if (!book) {
          throw failWithCode(404, 'Book not found');
        }
        await book.destroy();
      },
    }),
  }),
}).handler;

// file: pages/api/auth/token.ts
import { alwaysMatch } from 'next-create-endpoint-handler';
import z from 'zod';
import { createEndpoint } from '../../../src/logic/server';
import { getTokenForBody } from '../../../src/logic/server/auth';
import { schemaToInvariant } from '../../../src/schemas';

export default createEndpoint({
  methods: (build) => ({
    post: build.method({
      validators: {
        body: schemaToInvariant(
          z.object({
            username: z.string(),
            password: z.string(),
          })
        ),
        response: alwaysMatch<{ token: string }>(),
      },
      handler: async (req) => {
        const token = await getTokenForBody(req.body);
        return { token };
      },
    }),
  }),
  disableAuthentication: true,
}).handler;
```
